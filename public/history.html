<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - Wingo Casino</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            color: white;
        }
        .sidebar {
            background: rgba(0, 0, 0, 0.8);
            height: 100vh;
            position: fixed;
            width: 250px;
            border-right: 1px solid rgba(0, 255, 255, 0.3);
        }
        .main-content {
            margin-left: 250px;
            padding: 20px;
        }
        .card {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .history-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #00ffff;
        }
        .win-item {
            border-left-color: #00ff00;
        }
        .loss-item {
            border-left-color: #ff0000;
        }
        .result-badge {
            font-size: 1.2rem;
            padding: 8px 15px;
        }
        .stats-card {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            color: black;
            border: none;
        }
        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.7);
        }
        .nav-tabs .nav-link.active {
            background-color: #00ffff;
            color: black;
            border-color: #00ffff;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="p-3">
            <h3 class="text-center">üéÆ Wingo</h3>
            <hr class="text-info">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="/home">
                        <i class="fas fa-home me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/game-wingo">
                        <i class="fas fa-dice me-2"></i>Wingo Game
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/wallet">
                        <i class="fas fa-wallet me-2"></i>Wallet
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/history">
                        <i class="fas fa-history me-2"></i>History
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/profile">
                        <i class="fas fa-user me-2"></i>Profile
                    </a>
                </li>
                <li class="nav-item mt-3">
                    <a class="nav-link text-danger" href="#" id="logoutBtn">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="main-content">
        <div class="container-fluid">
            <div class="row mb-4">
                <div class="col-md-12">
                    <h1><i class="fas fa-history me-2"></i>Game History</h1>
                    <p>View your betting history and game results</p>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <h5>Total Bets</h5>
                            <h2 id="totalBets">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <h5>Wins</h5>
                            <h2 id="totalWins" class="text-success">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <h5>Win Rate</h5>
                            <h2 id="winRate">0%</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stats-card">
                        <div class="card-body text-center">
                            <h5>Net Profit</h5>
                            <h2 id="netProfit">‚Çπ0.00</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History Tabs -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="historyTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="bets-tab" data-bs-toggle="tab" data-bs-target="#bets" type="button" role="tab">
                                        <i class="fas fa-dice me-2"></i>My Bets
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab">
                                        <i class="fas fa-trophy me-2"></i>Game Results
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
                                        <i class="fas fa-exchange-alt me-2"></i>Transactions
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="historyTabContent">
                                <!-- My Bets Tab -->
                                <div class="tab-pane fade show active" id="bets" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4>Your Betting History</h4>
                                        <div>
                                            <select class="form-select form-select-sm" id="betsFilter" style="width: 150px; display: inline-block;">
                                                <option value="all">All Bets</option>
                                                <option value="won">Won</option>
                                                <option value="lost">Lost</option>
                                                <option value="pending">Pending</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="betsHistory">
                                        <p class="text-center text-muted">Loading betting history...</p>
                                    </div>
                                </div>

                                <!-- Game Results Tab -->
                                <div class="tab-pane fade" id="results" role="tabpanel">
                                    <h4>Recent Game Results</h4>
                                    <div id="gameResults">
                                        <p class="text-center text-muted">Loading game results...</p>
                                    </div>
                                </div>

                                <!-- Transactions Tab -->
                                <div class="tab-pane fade" id="transactions" role="tabpanel">
                                    <h4>Transaction History</h4>
                                    <div id="transactionHistory">
                                        <p class="text-center text-muted">Loading transaction history...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Authentication check
        const token = localStorage.getItem('access_token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || !user.id) {
            window.location.href = '/login';
        }

        // Load betting history
        async function loadBetsHistory(filter = 'all') {
            try {
                const response = await fetch(`/api/bet/history?limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const historyDiv = document.getElementById('betsHistory');
                    
                    // Filter bets
                    let filteredBets = data.bets;
                    if (filter !== 'all') {
                        filteredBets = data.bets.filter(bet => bet.status === filter);
                    }
                    
                    if (filteredBets.length > 0) {
                        let html = '';
                        filteredBets.forEach(bet => {
                            const statusClass = bet.status === 'won' ? 'win-item text-success' : 
                                              bet.status === 'lost' ? 'loss-item text-danger' : 'text-warning';
                            const statusIcon = bet.status === 'won' ? '‚úÖ' : 
                                             bet.status === 'lost' ? '‚ùå' : '‚è≥';
                            const payout = bet.status === 'won' ? `+‚Çπ${(bet.amount * getMultiplier(bet.bet_type, bet.bet_value)).toFixed(2)}` : `-‚Çπ${bet.amount}`;
                            
                            html += `
                                <div class="history-item ${bet.status === 'won' ? 'win-item' : bet.status === 'lost' ? 'loss-item' : ''}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${bet.bet_type}: ${bet.bet_value}</strong>
                                            <br><small class="text-muted">Game #${bet.game_id} ‚Ä¢ ${new Date(bet.created_at).toLocaleString()}</small>
                                        </div>
                                        <div class="text-end">
                                            <div class="${statusClass}">
                                                ${statusIcon} ${bet.status.toUpperCase()}
                                            </div>
                                            <div class="mt-1">
                                                <span class="badge bg-secondary me-2">Bet: ‚Çπ${bet.amount}</span>
                                                <span class="fw-bold">${payout}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        historyDiv.innerHTML = html;
                    } else {
                        historyDiv.innerHTML = '<p class="text-center text-muted">No bets found</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading bets history:', error);
            }
        }

        // Load game results
        async function loadGameResults() {
            try {
                const response = await fetch('/api/game/history?limit=30');
                if (response.ok) {
                    const data = await response.json();
                    const resultsDiv = document.getElementById('gameResults');
                    
                    if (data.results.length > 0) {
                        let html = '<div class="row">';
                        data.results.forEach(result => {
                            const colorClass = getResultColor(result.result);
                            html += `
                                <div class="col-md-2 col-4 mb-3">
                                    <div class="text-center">
                                        <span class="badge ${colorClass} result-badge">${result.result}</span>
                                        <div class="small text-muted mt-1">#${result.id}</div>
                                        <div class="small">${new Date(result.created_at).toLocaleTimeString()}</div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        resultsDiv.innerHTML = html;
                    } else {
                        resultsDiv.innerHTML = '<p class="text-center text-muted">No game results available</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading game results:', error);
            }
        }

        // Load transaction history
        async function loadTransactionHistory() {
            try {
                const response = await fetch('/api/wallet/transactions?limit=30', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const historyDiv = document.getElementById('transactionHistory');
                    
                    if (data.transactions.length > 0) {
                        let html = '';
                        data.transactions.forEach(tx => {
                            const typeIcon = getTransactionIcon(tx.type);
                            const amountClass = tx.type === 'deposit' || tx.type === 'win' ? 'text-success' : 'text-danger';
                            
                            html += `
                                <div class="history-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <i class="${typeIcon} me-2"></i>
                                            <strong>${tx.type.toUpperCase()}</strong>
                                            ${tx.description ? `<small class="d-block text-muted">${tx.description}</small>` : ''}
                                        </div>
                                        <div class="text-end">
                                            <span class="${amountClass}">${tx.type === 'deposit' || tx.type === 'win' ? '+' : '-'}‚Çπ${tx.amount.toFixed(2)}</span>
                                            <br><small class="text-muted">${new Date(tx.created_at).toLocaleString()}</small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        historyDiv.innerHTML = html;
                    } else {
                        historyDiv.innerHTML = '<p class="text-center text-muted">No transactions found</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading transaction history:', error);
            }
        }

        // Load statistics
        async function loadStatistics() {
            try {
                // Load bets for statistics
                const response = await fetch('/api/bet/history?limit=1000', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const bets = data.bets;
                    
                    const totalBets = bets.length;
                    const wins = bets.filter(bet => bet.status === 'won').length;
                    const losses = bets.filter(bet => bet.status === 'lost').length;
                    
                    // Calculate net profit (simplified)
                    let netProfit = 0;
                    bets.forEach(bet => {
                        if (bet.status === 'won') {
                            netProfit += (bet.amount * getMultiplier(bet.bet_type, bet.bet_value)) - bet.amount;
                        } else if (bet.status === 'lost') {
                            netProfit -= bet.amount;
                        }
                    });
                    
                    document.getElementById('totalBets').textContent = totalBets;
                    document.getElementById('totalWins').textContent = wins;
                    document.getElementById('winRate').textContent = totalBets > 0 ? `${Math.round((wins/totalBets) * 100)}%` : '0%';
                    document.getElementById('netProfit').textContent = `‚Çπ${netProfit.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Helper functions
        function getMultiplier(betType, betValue) {
            if (betType === 'big_small') return 2;
            if (betType === 'color') {
                return betValue === 'violet' ? 4.5 : 2;
            }
            if (betType === 'number') return 9;
            return 1;
        }

        function getResultColor(result) {
            const num = parseInt(result);
            if (num === 0 || num === 5) return 'bg-purple';
            if ([1,3,7,9].includes(num)) return 'bg-success';
            if ([2,4,6,8].includes(num)) return 'bg-danger';
            return 'bg-secondary';
        }

        function getTransactionIcon(type) {
            const icons = {
                'deposit': 'fas fa-arrow-down text-success',
                'withdrawal': 'fas fa-arrow-up text-warning',
                'bet': 'fas fa-dice text-primary',
                'win': 'fas fa-trophy text-success',
                'fee': 'fas fa-minus-circle text-danger'
            };
            return icons[type] || 'fas fa-exchange-alt';
        }

        // Add custom CSS for purple
        const style = document.createElement('style');
        style.textContent = `
            .bg-purple { background-color: #800080 !important; }
        `;
        document.head.appendChild(style);

        // Event listeners
        document.getElementById('betsFilter').addEventListener('change', function() {
            loadBetsHistory(this.value);
        });

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        });

        // Initialize
        loadBetsHistory();
        loadGameResults();
        loadTransactionHistory();
        loadStatistics();
    </script>
</body>
</html>